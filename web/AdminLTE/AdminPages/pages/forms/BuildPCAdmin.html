<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>AdminLTE 2 | Build PC - Create</title>
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
        <link rel="stylesheet" href="../../bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
        <link rel="stylesheet" href="../../dist/css/AdminLTE.min.css">
        <link rel="stylesheet" href="../../dist/css/skins/_all-skins.min.css">
        <style>
            .component-block {
                border: 1px solid #ddd;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 20px;
                background: #f9f9f9;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .component-image {
                width: 100px;
                height: 100px;
                margin-right: 15px;
            }
            .d-flex {
                display: flex;
                align-items: center;
            }
            .component-meta, .component-price {
                margin-top: 5px;
            }
            .modal-overplay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0,0,0,0.5);
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            .modal-content {
                background: white;
                padding: 20px;
                border-radius: 8px;
                width: 80%;
                max-width: 600px;
            }
        </style>
    </head>

    <body class="hold-transition skin-blue sidebar-mini">
        <div class="wrapper">


            <!-- HEADER -->
            <header class="main-header">
                <!-- Logo -->
                <a href="${ctx}/AdminDashbordServlet" class="logo">
                    <span class="logo-mini"><b>A</b>LT</span>
                    <span class="logo-lg"><b>Admin</b>LTE</span>
                </a>
                <!-- Navbar -->
                <nav class="navbar navbar-static-top">
                    <button class="sidebar-toggle" data-toggle="offcanvas" aria-label="Toggle navigation">
                        <span class="sr-only">Toggle navigation</span>
                    </button>
                    <div class="navbar-custom-menu">
                        <ul class="nav navbar-nav">
                            <!-- Messages -->
                            <li class="dropdown messages-menu">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="fa fa-envelope-o"></i>
                                    <span class="label label-success">4</span>
                                </a>
                                <!-- Message Dropdown Here -->
                            </li>
                            <!-- Notifications -->
                            <li class="dropdown notifications-menu">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="fa fa-bell-o"></i>
                                    <span class="label label-warning">10</span>
                                </a>
                                <!-- Notifications Dropdown Here -->
                            </li>
                            <!-- Tasks -->
                            <li class="dropdown tasks-menu">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="fa fa-flag-o"></i>
                                    <span class="label label-danger">9</span>
                                </a>
                                <!-- Tasks Dropdown Here -->
                            </li>
                            <!-- User Account -->
                            <li class="dropdown user user-menu">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <img src="${ctx}/AdminLTE/dist/img/user2-160x160.jpg" class="user-image" alt="User">
                                    <span class="hidden-xs">Alexander Pierce</span>
                                </a>
                                <!-- User Menu Dropdown Here -->
                            </li>
                            <!-- Settings -->
                            <li>
                                <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </header>
            <!-- SIDEBAR -->
            <aside class="main-sidebar">
                <section class="sidebar">
                    <div class="user-panel">
                        <div class="pull-left image">
                            <img src="/ComputerOnlineShop/AdminLTE/AdminPages/dist/img/user2-160x160.jpg" class="img-circle" alt="User">
                        </div>
                        <div class="pull-left info">
                            <p>Alexander Pierce</p>
                            <a href="#"><i class="fa fa-circle text-success"></i> Online</a>
                        </div>
                    </div>
                    <form action="#" method="get" class="sidebar-form">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control" placeholder="Search...">
                            <span class="input-group-btn">
                                <button type="submit" name="search" id="search-btn" class="btn btn-flat">
                                    <i class="fa fa-search"></i>
                                </button>
                            </span>
                        </div>
                    </form>
                    <ul class="sidebar-menu">
                        <li class="header">MAIN NAVIGATION</li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Brand</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/BrandAdmin"><i class="fa fa-circle-o"></i>View Brand</a></li>
                                <li><a href="/ComputerOnlineShop/BrandAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert new Brand</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Component</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/ComAdmin"><i class="fa fa-circle-o"></i>View Component</a></li>
                                <li><a href="/ComputerOnlineShop/ComAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert new Component</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>BraCom</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/BrandComAdmin"><i class="fa fa-circle-o"></i>View Bra-Com</a></li>
                                <li><a href="/ComputerOnlineShop/BrandComAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert new Brand-Com</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Category</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/CateAdmin"><i class="fa fa-circle-o"></i>View Category</a></li>
                                <li><a href="/ComputerOnlineShop/CateAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert new Category</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Import</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/Import"><i class="fa fa-circle-o"></i>View Import</a></li>
                                <li><a href="/ComputerOnlineShop/Import?service=insert"><i class="fa fa-circle-o"></i>Insert new Import</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Product</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/ProductAdmin"><i class="fa fa-circle-o"></i>View Product</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Warranty</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/WarrantyAdmin"><i class="fa fa-circle-o"></i>View Warranty</a></li>
                                <li><a href="/ComputerOnlineShop/WarrantyAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert Warranty</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Warranty Detail</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/WDA"><i class="fa fa-circle-o"></i>View Warranty Detail</a></li>
                                <li><a href="/ComputerOnlineShop/WDA?service=insert"><i class="fa fa-circle-o"></i>Insert Warranty Detail</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Order</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/OrderAdmin"><i class="fa fa-circle-o"></i>View Order</a></li>
                                <li><a href="/ComputerOnlineShop/OrderAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert new Order</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Feedback</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/FeedBackAdmin"><i class="fa fa-circle-o"></i>View Feedback</a></li>
                                <li><a href="/ComputerOnlineShop/FeedBackAdmin?service=insert"><i class="fa fa-circle-o"></i>Insert new Feedback</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>Blogs</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/bloga"><i class="fa fa-circle-o"></i>View Blog</a></li>
                                <li><a href="/ComputerOnlineShop/BlogAdmin&service=insert"><i class="fa fa-circle-o"></i>Insert new Blog</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-users"></i> <span>User Management</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/Admin/user?type=admin"><i class="fa fa-circle-o"></i>View Admins</a></li>
                                <li><a href="/ComputerOnlineShop/Admin/user?type=customer"><i class="fa fa-circle-o"></i>View Customers</a></li>
                                <li><a href="/ComputerOnlineShop/Admin/user?type=sale"><i class="fa fa-circle-o"></i>View Sales</a></li>
                                <li><a href="/ComputerOnlineShop/Admin/user?type=shipper"><i class="fa fa-circle-o"></i>View Shippers</a></li>
                                <li><a href="/ComputerOnlineShop/Admin/user/add"><i class="fa fa-circle-o"></i>Create new user</a></li>
                            </ul>
                        </li>
                        <li class="treeview">
                            <a href="#">
                                <i class="fa fa-laptop"></i> <span>BuildPC</span>
                                <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                            </a>
                            <ul class="treeview-menu">
                                <li><a href="/ComputerOnlineShop/BuildPC_ListCate?service=list"><i class="fa fa-circle-o"></i> View PC</a></li>
                                <li><a href="/ComputerOnlineShop/AdminLTE/AdminPages/pages/forms/BuildPCAdmin.html"><i class="fa fa-circle-o"></i>Create new PC</a></li>
                            </ul>
                        </li>
                    </ul>
                </section>
            </aside>

            <!-- CONTENT -->
            <div class="content-wrapper">
                <section class="content-header">
                    <h1 class="text-center">Build Your PC</h1>
                </section>
                <section class="content">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-7">
                                <!-- MainBoard -->
                                <div class="component-block" id="component-2">
                                    <div class="d-flex align-items-center">
                                        <img id="img-2" src="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" data-default="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" alt="MainBoard" class="component-image">
                                        <div>
                                            <strong>MainBoard</strong>
                                            <div id="meta-2" class="component-meta"></div>
                                            <div id="price-2" class="component-price"></div>
                                            <button id="remove-2" class="btn btn-sm btn-danger mt-2" style="display:none;" onclick="removeComponent(2)">Remove</button>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="openModal(2, 'MainBoard')">Choose</button>
                                </div>

                                <!-- CPU -->
                                <div class="component-block" id="component-3">
                                    <div class="d-flex align-items-center">
                                        <img id="img-3" src="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" data-default="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" alt="CPU" class="component-image">
                                        <div>
                                            <strong>CPU</strong>
                                            <div id="meta-3" class="component-meta"></div>
                                            <div id="price-3" class="component-price"></div>
                                            <button id="remove-3" class="btn btn-sm btn-danger mt-3" style="display:none;" onclick="removeComponent(3)">Remove</button>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="openModal(3, 'CPU')">Choose</button>
                                </div>

                                <!-- GPU -->
                                <div class="component-block" id="component-4">
                                    <div class="d-flex align-items-center">
                                        <img id="img-4" src="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" data-default="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" alt="GPU" class="component-image">
                                        <div>
                                            <strong>GPU</strong>
                                            <div id="meta-4" class="component-meta"></div>
                                            <div id="price-4" class="component-price"></div>
                                            <button id="remove-4" class="btn btn-sm btn-danger mt-4" style="display:none;" onclick="removeComponent(4)">Remove</button>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="openModal(4, 'GPU')">Choose</button>
                                </div>

                                <!-- RAM -->
                                <div class="component-block" id="component-5">
                                    <div class="d-flex align-items-center">
                                        <img id="img-5" src="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" data-default="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" alt="RAM" class="component-image">
                                        <div>
                                            <strong>RAM</strong>
                                            <div id="meta-5" class="component-meta"></div>
                                            <div id="price-5" class="component-price"></div>
                                            <button id="remove-5" class="btn btn-sm btn-danger mt-5" style="display:none;" onclick="removeComponent(5)">Remove</button>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="openModal(5, 'RAM')">Choose</button>
                                </div>

                                <!-- SSD -->
                                <div class="component-block" id="component-6">
                                    <div class="d-flex align-items-center">
                                        <img id="img-6" src="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" data-default="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" alt="SSD" class="component-image">
                                        <div>
                                            <strong>SSD</strong>
                                            <div id="meta-6" class="component-meta"></div>
                                            <div id="price-6" class="component-price"></div>
                                            <button id="remove-6" class="btn btn-sm btn-danger mt-6" style="display:none;" onclick="removeComponent(6)">Remove</button>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="openModal(6, 'SSD')">Choose</button>
                                </div>

                                <!-- Case -->
                                <div class="component-block" id="component-7">
                                    <div class="d-flex align-items-center">
                                        <img id="img-7" src="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" data-default="/ComputerOnlineShop/ShopPages/Pages/images/anhproduct/2.jpg" alt="Case" class="component-image">
                                        <div>
                                            <strong>Case</strong>
                                            <div id="meta-7" class="component-meta"></div>
                                            <div id="price-7" class="component-price"></div>
                                            <button id="remove-7" class="btn btn-sm btn-danger mt-7" style="display:none;" onclick="removeComponent(7)">Remove</button>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="openModal(7, 'Case')">Choose</button>
                                </div>

                            </div>
                            <div class="modal-overplay" id="customModal">
                                <div class="modal-content">
                                    <span class="close-btn" id="closeModal">&times;</span>
                                    <h4 id="modalTitle">SelectComponent</h4>
                                    <div id="modalBody">Loading...</div>
                                </div>
                            </div>
                            <div class="card border p-3 mt-3">
                                <h4 class="text-center mb-3">Tổng tiền</h4>
                                <h3 class="text-center text-success"><span id="totalPrice">0</span>₫</h3>
                            </div>

                            <div class="text-center mt-3">
                                <button class="btn btn-success btn-lg" onclick="submitBuildPC()">Tạo Build PC</button>
                            </div>

                        </div>
                </section>
            </div>
        </div>

        <!-- Scripts -->
        <script src="../../plugins/jQuery/jquery-2.2.3.min.js"></script>
        <script src="../../bootstrap/js/bootstrap.min.js"></script>
        <script src="../../dist/js/app.min.js"></script>
        <script>
                                    const ctx = "/ComputerOnlineShop"; // Change if needed
                                    const modal = document.getElementById('customModal');
                                    const modalTitle = document.getElementById('modalTitle');
                                    const modalBody = document.getElementById('modalBody');
                                    const totalDisplay = document.getElementById('totalPrice');

                                    let selectedComponents = JSON.parse(localStorage.getItem("selectedComponents")) || {};
                                    // open
                                    function openModal(componentid, componentName) {
                                        modal.style.display = 'flex';
                                        modalTitle.innerText = `Select ${componentName}`;
                                        modalBody.innerHTML = `<p>Loading...</p>`;
                                        fetch(`${ctx}/BuildPC_ListCate?service=filter&componentID=${componentid}&ajax=true`)

                                                .then(res => res.text())
                                                .then(html => {
                                                    modalBody.innerHTML = html;
                                                    attachFilterFormHandler(componentid, componentName);
                                                    attachPaginationHandler(componentid, componentName);
                                                })
                                                .catch(() => {
                                                    modalBody.innerHTML = "<p style='color:red;'>Failed to load data</p>";
                                                });
                                    }
                                    //close
                                    document.getElementById('closeModal').addEventListener('click', () => {
                                        modal.style.display = 'none';
                                    });
                                    window.addEventListener('click', function (e) {
                                        const modalOverlay = document.getElementById('customModal');
                                        const modalContent = document.querySelector('.modal-content');

                                        const isModalOpen = modalOverlay.style.display === 'flex';


                                        if (isModalOpen && e.target === modalOverlay) {
                                            modalOverlay.style.display = 'none';
                                        }
                                    });

                                    window.addEventListener("load", () => {
                                        for (const compID of Object.keys(selectedComponents)) {
                                            const comp = selectedComponents[compID];
                                            selectProduct(compID, comp.categoryName, comp.brandName, comp.price, comp.imgURL, comp.categoryID);
                                        }
                                    });

                                    function attachFilterFormHandler(componentID, componentName) {
                                        const filterForm = modalBody.querySelector('#filterForm');
                                        if (filterForm) {
                                            filterForm.addEventListener('submit', function (e) {
                                                e.preventDefault();
                                                const url = filterForm.action + '?' + new URLSearchParams(new FormData(filterForm)).toString();
                                                fetch(url)
                                                        .then(res => res.text())
                                                        .then(innerHtml => {
                                                            modalBody.innerHTML = innerHtml;
                                                            attachFilterFormHandler(componentID, componentName);
                                                      
                                                        });
                                            });
                                        }
                                    }

                                    function attachPaginationHandler(componentID, componentName) {
                                        modalBody.querySelectorAll(".page-link").forEach(link => {
                                            link.addEventListener("click", function (e) {
                                                e.preventDefault();
                                                const page = parseInt(this.textContent.trim());
                                                if (!isNaN(page)) {
                                                    goToPage(page, componentID, componentName);
                                                }
                                            });
                                        });
                                    }
                                    // make page
                                    function goToPage(page, componentID, componentName) {
                                        const filterForm = modalBody.querySelector('#filterForm');
                                        if (filterForm) {
                                            const formData = new FormData(filterForm);
                                            formData.set("page", page);
                                            const url = filterForm.action + "?" + new URLSearchParams(formData).toString();
                                            modalBody.innerHTML = "<p>Loading...</p>";
                                            fetch(url)
                                                    .then(res => res.text())
                                                    .then(html => {
                                                        modalBody.innerHTML = html;
                                                        attachFilterFormHandler(componentID, componentName);
                                                        attachPaginationHandler(componentID, componentName);
                                                        modalBody.scrollTop = 0;
                                                    });
                                        }
                                    }

                                    function selectProduct(componentID, categoryName, brandName, price, imgURL, categoryID) {
                                        document.getElementById(`meta-${componentID}`).innerText = `${categoryName} - ${brandName}`;
                                        document.getElementById(`price-${componentID}`).innerText = `${price.toLocaleString()}₫`;
                                        document.getElementById(`remove-${componentID}`).style.display = 'inline-block';

                                        const image = document.getElementById(`img-${componentID}`);
                                        if (image) {
                                            image.src = `${ctx}/ShopPages/Pages/images/anhproduct/${imgURL}`;
                                        }

                                        selectedComponents[componentID] = {
                                            categoryID: categoryID,
                                            categoryName: categoryName,
                                            brandName: brandName,
                                            price: price,
                                            imgURL: imgURL
                                        };
                                        localStorage.setItem("selectedComponents", JSON.stringify(selectedComponents));
                                        updateTotal();

                                        document.getElementById('customModal').style.display = 'none';
                                    }




                                    function removeComponent(componentID) {
                                        delete selectedComponents[componentID];
                                        localStorage.setItem("selectedComponents", JSON.stringify(selectedComponents));
                                        document.getElementById(`img-${componentID}`).src = document.getElementById(`img-${componentID}`).dataset.default;
                                        document.getElementById(`meta-${componentID}`).innerText = "";
                                        document.getElementById(`price-${componentID}`).innerText = "";
                                        document.getElementById(`remove-${componentID}`).style.display = 'none';
                                        updateTotal();
                                    }

                                    function updateTotal() {
                                        let total = 0;
                                        Object.values(selectedComponents).forEach(comp => total += comp.price);
                                        totalDisplay.innerText = total.toLocaleString() + "₫";
                                    }


                                    function submitBuildPC() {
                                        const selected = Object.values(selectedComponents);

                                        const requiredComponents = [2, 3, 4, 5, 6, 7];
                                        const selectedIDs = Object.keys(selectedComponents).map(Number);

                                        const hasAllRequired = requiredComponents.every(id => selectedIDs.includes(id));
                                        if (!hasAllRequired) {
                                            alert("Bạn cần chọn đủ 6 linh kiện: MainBoard, CPU, GPU, RAM, SSD, CASE.");
                                            return;
                                        }

                                        const categoryIDs = requiredComponents.map(id => selectedComponents[id].categoryID).join(",");

                                        fetch(`${ctx}/BuildPC_ListCate?service=insert`, {
                                            method: "POST",
                                            headers: {
                                                'Content-Type': 'application/x-www-form-urlencoded'
                                            },
                                            body: `categoryIDs=${encodeURIComponent(categoryIDs)}`
                                        })
                                                .then(res => {
                                                    if (!res.ok) {
                                                        return res.text().then(msg => {
                                                            throw new Error(msg);
                                                        });
                                                    }
                                                    return res.text();
                                                })
                                                .then(msg => {
                                                    alert("Tạo Build PC thành công!");
                                                    localStorage.removeItem("selectedComponents");
                                                    window.location.href = `${ctx}/BuildPC_ListCate?service=list`;
                                                })
                                                .catch(err => {
                                                    if (err.message.includes("409")) {
                                                        alert("Build PC với 6 linh kiện này đã tồn tại. Hãy chọn cấu hình khác.");
                                                    } else {
                                                        alert("Lỗi khi tạo Build PC: " + err.message);
                                                    }
                                                });

                                    }
                                    console.log("selectedComponents:", selectedComponents);



                                    function updateComponentUI(item) {
                                        const componentID = item.componentID;
                                        const categoryName = item.categoryName;
                                        const brandName = item.brandName;
                                        const price = item.price;
                                        const imgURL = item.imgURL;
                                        const categoryID = item.categoryID;

                                        document.getElementById(`meta-${componentID}`).innerText = `${categoryName} - ${brandName}`;
                                        document.getElementById(`price-${componentID}`).innerText = `${price.toLocaleString()}₫`;
                                        document.getElementById(`remove-${componentID}`).style.display = 'inline-block';

                                        const image = document.getElementById(`img-${componentID}`);
                                        if (image) {
                                            image.src = `${ctx}/ShopPages/Pages/images/anhproduct/${imgURL}`;
                                        }

                                        // Lưu lại vào selectedComponents
                                        selectedComponents[componentID] = {
                                            categoryID,
                                            categoryName,
                                            brandName,
                                            price,
                                            imgURL
                                        };
                                        updateTotal();
                                    }



                                    window.addEventListener("DOMContentLoaded", function () {
                                        const urlParams = new URLSearchParams(window.location.search);
                                        const buildPCID = urlParams.get("buildPCID");

                                        if (buildPCID) {
                                            const btn = document.querySelector("button.btn-success");
                                            if (btn) {
                                                btn.innerText = "Cập nhật Build PC";
                                                btn.onclick = function () {
                                                    submitUpdateBuildPC(buildPCID);
                                                };
                                            }

                                            // Gọi API load dữ liệu
                                            fetch(`${ctx}/BuildPC_ListCate?service=loadBuildPC&buildPCID=${buildPCID}`)
                                                    .then(res => res.json())
                                                    .then(data => {
                                                        if (Array.isArray(data)) {
                                                            data.forEach(item => {
                                                                updateComponentUI(item);
                                                            });
                                                            localStorage.setItem("selectedComponents", JSON.stringify(selectedComponents));
                                                        }
                                                    });
                                        }
                                    });

                                    function submitUpdateBuildPC(buildPCID) {
                                        const requiredComponents = [2, 3, 4, 5, 6, 7];
                                        const selectedIDs = Object.keys(selectedComponents).map(Number);
                                        const hasAllRequired = requiredComponents.every(id => selectedIDs.includes(id));
                                        if (!hasAllRequired) {
                                            alert("Bạn cần chọn đủ 6 linh kiện: MainBoard, CPU, GPU, RAM, SSD, CASE.");
                                            return;
                                        }

                                        const categoryIDs = requiredComponents.map(id => selectedComponents[id].categoryID).join(",");

                                        fetch(`${ctx}/BuildPC_ListCate?service=update`, {
                                            method: "POST",
                                            headers: {
                                                'Content-Type': 'application/x-www-form-urlencoded'
                                            },
                                            body: `buildPCID=${buildPCID}&categoryIDs=${encodeURIComponent(categoryIDs)}`
                                        })
                                                .then(res => {
                                                    if (!res.ok)
                                                        return res.text().then(msg => {
                                                            throw new Error(msg);
                                                        });
                                                    return res.text();
                                                })
                                                .then(msg => {
                                                    alert("Cập nhật Build PC thành công!");
                                                    localStorage.removeItem("selectedComponents");
                                                    window.location.href = `${ctx}/BuildPC_ListCate?service=list`;
                                                })
                                                .catch(err => {
                                                    if (err.message.includes("409")) {
                                                        alert(" Build PC với 6 linh kiện này đã tồn tại. Hãy chọn cấu hình khác.");
                                                    } else {
                                                        alert("Lỗi khi tạo Build PC: " + err.message);
                                                    }
                                                });

                                    }



        </script>

    </body>
</html>